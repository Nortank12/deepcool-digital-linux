export DIRENV_LOG_FORMAT="direnv: error %s"

if [[ -d ".devenv" ]]; then
  CHECKSUM_FILE=".devenv/.file_checksums"
  CURRENT_CHECKSUMS=$(find . -maxdepth 1 -name "flake.lock" -o -name ".envrc" | sort | xargs sha256sum)
  
  if [[ -f "$CHECKSUM_FILE" ]]; then
    STORED_CHECKSUMS=$(cat "$CHECKSUM_FILE")
    if [[ "$STORED_CHECKSUMS" != "$CURRENT_CHECKSUMS" ]]; then
      echo "flake.lock or .envrc changed - cleaning up .devenv directory..."
      rm -rf .devenv
    fi
  fi
  
  mkdir -p .devenv
  echo "$CURRENT_CHECKSUMS" > "$CHECKSUM_FILE"
fi

use_flake
